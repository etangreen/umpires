% 1) compiles the grid search files
% 2) finds the optimal parameter values
% 3) calculates standard errors for the variance terms

clear, addpath('functions/'), s = getParams; load('../data/prelim')

%% compile estimates

M = nan(s.N_eval,3); cov = nan(s.N_eval,3,2); 
for j=1:3
    for t=1:s.N_eval
        load(['../data/model/',num2str(j),'_',num2str(t)])
        M(t,j) = L; cov(t,j,:) = cov_hat;
    end
end

%% find optimal parameter values

[minL,ind] = min(M); S_hat = s.evalPts(ind,:);
cov_hat = [diag(cov(ind,:,1)) diag(cov(ind,:,2))];

%% standard errors from approximate Hessian

V = int8(round(s.evalPts*10));
X = [-1 0; 1 0; 0 -1; 0 1; -1 -1; -1 1; 1 -1; 1 1]/10;

% objective function values near optimum
S = int8(round(S_hat(3,:)*10));
L_10 = M(min(V == [S(1)-1, S(2)],[],2),3);
L10 = M(min(V == [S(1)+1, S(2)],[],2),3);
L0_1 = M(min(V == [S(1), S(2)-1],[],2),3);
L01 = M(min(V == [S(1), S(2)+1],[],2),3);
L_1_1 = M(min(V == [S(1)-1, S(2)-1],[],2),3);
L_11 = M(min(V == [S(1)-1, S(2)+1],[],2),3);
L1_1 = M(min(V == [S(1)+1, S(2)-1],[],2),3);
L11 = M(min(V == [S(1)+1, S(2)+1],[],2),3);

% fit paraboloid
Lij = [L_10 L10 L0_1 L01 L_1_1 L_11 L1_1 L11]';
f = @(b) sum((b(1) * X(:,1).^2 + b(2) * X(:,2).^2 ...
    + b(3) * X(:,1) .* X(:,2) + minL(3) - Lij).^2);
param = fminunc(@(b) f(b),[0 0 0]);

% Hessian and standard errors
Hess = [2*param(1) param(3); param(3) 2*param(2)];
se = sqrt(diag(inv(Hess)));
fprintf('Standard errors: [%1.2f, %1.2f]\n', se(1), se(2))

%% find boundaries of strike zone

pool = parpool(3);

x = zeros(s.N_c,2,3); e = zeros(2,2,3); box = zeros(5,2,2,'int8');
for h=1:2
    N_S = H{h}.calls;
    parfor j=1:3
        [~,b_i,y_hat,predicted,p] = ...
            getLoss(S_hat(j,:),cov_hat(j,h),priors{j}{h},H{h},s.Z{h});

        x(:,h,j) = sum(y_hat(:,:,b_i));
        
        b = s.bounds{h}(b_i,:); p = p(:,:,b_i); Z = s.Z{h}(:,b_i);
        e(:,j,h) = [s.error(p,s.Z_off,N_S); s.error(p,Z,N_S)];
        
        fprintf('%sHB model %d: [%d %d %d %d]\n', ...
            s.hands{h},j,b(1),b(2),b(3),b(4))
        mvnradius(S_hat(j,:),cov_hat(j,h))
    end

    % implied strike zone with count-specific prior
    box(:,1,h) = [-b(2); -b(2); b(1); b(1); -b(2)];
    box(:,2,h) = [-b(4); b(3); b(3); -b(4); -b(4)];
end

delete(pool)

%% save

save('../data/structural', 'S_hat'